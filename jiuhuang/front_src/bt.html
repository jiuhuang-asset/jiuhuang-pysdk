<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quant Strategy Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.10.0/dist/reset.css">
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/antd@5.10.0/dist/antd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>

    <style>
        body { background: #f0f2f5; padding: 24px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); margin-bottom: 24px; }
        .filter-item { display: flex; flex-direction: column; gap: 8px; min-width: 200px; }
        .filter-label { font-weight: 500; color: #555; font-size: 14px; }
        #chart-container { width: 100%; height: 600px; }
        .section-title { margin-bottom: 16px; font-size: 18px; font-weight: 600; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/javascript">
    const { Select, Space, Row, Col, Card } = window.antd;
    let myChart = null;
    let rawData = [];
    let perfData = [];

    // --- React 控制面板组件 ---
    const ControlPanel = () => {
        const [symbols, setSymbols] = React.useState([]);
        const [strategies, setStrategies] = React.useState([]);
        const [selectedSymbol, setSelectedSymbol] = React.useState(null);
        const [selectedStrategy, setSelectedStrategy] = React.useState(null);

        React.useEffect(() => {
            window.addEventListener('pywebviewready', async () => {
                const res = await pywebview.api.init_data();
                rawData = res.main_data;
                perfData = res.perf_data;

                const syms = [...new Set(rawData.map(d => d.symbol))];
                const strats = [...new Set(rawData.map(d => d.strategy))];
                
                setSymbols(syms.map(s => ({ value: s, label: s })));
                setStrategies(strats.map(s => ({ value: s, label: s })));
                
                setSelectedSymbol(syms[0]);
                setSelectedStrategy(strats[0]);
                
                initChart();
                updateGridTable();
            });
        }, []);

        React.useEffect(() => {
            if (selectedSymbol && selectedStrategy) {
                refreshChart(selectedSymbol, selectedStrategy);
            }
        }, [selectedSymbol, selectedStrategy]);

        return React.createElement(Card, { className: "card" }, 
            React.createElement(Row, { gutter: 24 }, [
                React.createElement(Col, null, 
                    React.createElement('div', { className: "filter-item" }, [
                        React.createElement('span', { className: "filter-label" }, "股票代码 (Symbol)"),
                        React.createElement(Select, {
                            showSearch: true,
                            placeholder: "搜索代码",
                            value: selectedSymbol,
                            onChange: setSelectedSymbol,
                            options: symbols,
                            style: { width: 200 }
                        })
                    ])
                ),
                React.createElement(Col, null, 
                    React.createElement('div', { className: "filter-item" }, [
                        React.createElement('span', { className: "filter-label" }, "交易策略 (Strategy)"),
                        React.createElement(Select, {
                            showSearch: true,
                            placeholder: "选择策略",
                            value: selectedStrategy,
                            onChange: setSelectedStrategy,
                            options: strategies,
                            style: { width: 200 }
                        })
                    ])
                )
            ])
        );
    };

    // --- ECharts 逻辑 ---
    function initChart() {
        myChart = echarts.init(document.getElementById('chart-container'));
        window.addEventListener('resize', () => myChart.resize());
    }

    function refreshChart(symbol, strategy) {
        const data = rawData.filter(d => d.symbol === symbol && d.strategy === strategy);
        const dates = data.map(d => d.date);
        const prices = data.map(d => d.close);
        const volumes = data.map(d => d.volume || Math.random() * 1000); // 备选模拟量
        const buys = data.filter(d => d.buy_signal === 1).map(d => [d.date, d.close]);

        const option = {
            animation: false,
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            // 定义两个网格：上下排布
            grid: [
                { left: '5%', right: '5%', height: '60%', top: '10%' }, // 主图
                { left: '5%', right: '5%', top: '75%', height: '15%' }  // 子图
            ],
            xAxis: [
                { type: 'category', data: dates, gridIndex: 0, axisLabel: { show: false } },
                { type: 'category', data: dates, gridIndex: 1 }
            ],
            yAxis: [
                { scale: true, gridIndex: 0, name: 'Price' },
                { scale: true, gridIndex: 1, name: 'Vol', splitNumber: 2 }
            ],
            series: [
                { name: 'Price', type: 'line', data: prices, xAxisIndex: 0, yAxisIndex: 0, smooth: true },
                { 
                    name: 'Buy Signal', type: 'scatter', data: buys, 
                    xAxisIndex: 0, yAxisIndex: 0, symbol: 'triangle', symbolSize: 12, itemStyle: { color: '#f5222d' } 
                },
                { name: 'Volume', type: 'bar', data: volumes, xAxisIndex: 1, yAxisIndex: 1, itemStyle: { color: '#1890ff' } }
            ],
            // 联动缩放
            dataZoom: [{ type: 'inside', xAxisIndex: [0, 1] }, { type: 'slider', xAxisIndex: [0, 1] }]
        };
        myChart.setOption(option, true);
    }

    // --- Grid.js 表格 ---
    function updateGridTable() {
        new gridjs.Grid({
            columns: ['Symbol', 'Turtle', 'SMA', 'Mean_Reversion'],
            data: perfData.map(d => [d.symbol, d.turtle, d.sma, d.mean_reversion]),
            sort: true,
            pagination: { limit: 10 },
            search: true
        }).render(document.getElementById('performance-table'));
    }

    // 渲染页面结构
    const App = () => React.createElement('div', null, [
        React.createElement(ControlPanel),
        React.createElement('div', { className: "card" }, [
            React.createElement('div', { className: "section-title" }, "价格走势与成交量"),
            React.createElement('div', { id: "chart-container" })
        ]),
        React.createElement('div', { className: "card" }, [
            React.createElement('div', { className: "section-title" }, "策略表现排名"),
            React.createElement('div', { id: "performance-table" })
        ])
    ]);

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));

</script>
</body>
</html>