<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quant Strategy Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.10.0/dist/reset.css">
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/antd@5.10.0/dist/antd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>

    <style>
        body { background: #f0f2f5; padding: 24px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); margin-bottom: 24px; }
        .filter-item { display: flex; flex-direction: column; gap: 8px; min-width: 200px; }
        .filter-label { font-weight: 500; color: #555; font-size: 14px; }
        #chart-container { width: 100%; height: 600px; }
        .section-title { margin-bottom: 16px; font-size: 18px; font-weight: 600; }
        .ma-switch .ant-switch {
            width: 50px !important;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/javascript">
    const { Select, Switch, Space, Row, Col, Card } = window.antd;
    let myChart = null;
    let rawData = [];
    let perfData = [];

    // --- React 控制面板组件 ---
    const ControlPanel = () => {
        const [symbols, setSymbols] = React.useState([]);
        const [strategies, setStrategies] = React.useState([]);
        const [selectedSymbol, setSelectedSymbol] = React.useState(null);
        const [selectedStrategy, setSelectedStrategy] = React.useState(null);
        const [maEnabled, setMaEnabled] = React.useState(false);
        const [maPeriods, setMaPeriods] = React.useState([12]); // Default to 12-day MA

        React.useEffect(() => {
            window.addEventListener('pywebviewready', async () => {
                const res = await pywebview.api.init_data();
                rawData = res.main_data;
                perfData = res.perf_data;

                const syms = [...new Set(rawData.map(d => d.symbol))];
                const strats = [...new Set(rawData.map(d => d.strategy))];

                setSymbols(syms.map(s => ({ value: s, label: s })));
                setStrategies(strats.map(s => ({ value: s, label: s })));

                setSelectedSymbol(syms[0]);
                setSelectedStrategy(strats[0]);

                initChart();
                updateGridTable();
            });
        }, []);

        React.useEffect(() => {
            if (selectedSymbol && selectedStrategy) {
                refreshChart(selectedSymbol, selectedStrategy, maEnabled, maPeriods);
            }
        }, [selectedSymbol, selectedStrategy, maEnabled, maPeriods]);

        return React.createElement(Card, { className: "card" },
            React.createElement(Row, { gutter: 24 }, [
                React.createElement(Col, null,
                    React.createElement('div', { className: "filter-item" }, [
                        React.createElement('span', { className: "filter-label" }, "股票代码 (Symbol)"),
                        React.createElement(Select, {
                            showSearch: true,
                            placeholder: "搜索代码",
                            value: selectedSymbol,
                            onChange: setSelectedSymbol,
                            options: symbols,
                            style: { width: 200 }
                        })
                    ])
                ),
                React.createElement(Col, null,
                    React.createElement('div', { className: "filter-item" }, [
                        React.createElement('span', { className: "filter-label" }, "交易策略 (Strategy)"),
                        React.createElement(Select, {
                            showSearch: true,
                            placeholder: "选择策略",
                            value: selectedStrategy,
                            onChange: setSelectedStrategy,
                            options: strategies,
                            style: { width: 200 }
                        })
                    ])
                ),
                React.createElement(Col, null,
                    React.createElement('div', { className: "filter-item" }, [
                        React.createElement('span', { className: "filter-label" }, "添加均线"),
                        React.createElement(Switch, {
                            style: { width: '60px' },
                            checked: maEnabled,
                            onChange: setMaEnabled
                        })
                    ])
                ),
                maEnabled && React.createElement(Col, null,
                    React.createElement('div', { className: "filter-item" }, [
                        React.createElement('span', { className: "filter-label" }, "MA周期"),
                        React.createElement(Select, {
                            mode: 'multiple', // Enable multi-select
                            placeholder: "选择均线周期",
                            value: maPeriods,
                            onChange: setMaPeriods,
                            options: [
                                { value: 12, label: '12天' },
                                { value: 24, label: '24天' },
                                { value: 48, label: '48天' }
                            ],
                            style: { width: 200 }
                        })
                    ])
                )
            ])
        );
    };

    // --- ECharts 逻辑 ---
    function initChart() {
        myChart = echarts.init(document.getElementById('chart-container'));
        window.addEventListener('resize', () => myChart.resize());
    }

    function refreshChart(symbol, strategy, maEnabled, maPeriods) {
    const data = rawData.filter(d => d.symbol === symbol && d.strategy === strategy);
    const dates = data.map(d => d.date);
    const prices = data.map(d => d.close);
    const volumes = data.map(d => d.volume || Math.random() * 1000);

    // Calculate MAs for each selected period
    const maSeries = [];
    if (maEnabled && maPeriods.length > 0) {
        maPeriods.forEach(period => {
            const maValues = calculateMA(prices, period);
            maSeries.push({
                name: `MA${period}`,
                type: 'line', // Line chart for MA
                data: maValues,
                xAxisIndex: 0,
                yAxisIndex: 0,
                smooth: true,
                lineStyle: { color: getColorForPeriod(period) } // Assign different colors
            });
        });
    }

    // Process signals
    const signals = data.map(d => {
        if (d.buy_signal === 1) return { date: d.date, value: d.close, type: 'buy' };
        if (d.sell_signal === 1) return { date: d.date, value: d.close, type: 'sell' };
        return null;
    }).filter(signal => signal !== null);

    const buySignals = signals.filter(s => s.type === 'buy').map(s => [s.date, s.value]);
    const sellSignals = signals.filter(s => s.type === 'sell').map(s => [s.date, s.value]);

    const option = {
        animation: false,
        tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
        legend: {
            data: ['Price', ...maSeries.map(series => series.name), '买入', '卖出'],
            top: 'top'
        },
        grid: [
            { left: '5%', right: '5%', height: '60%', top: '10%' },
            { left: '5%', right: '5%', top: '75%', height: '15%' }
        ],
        xAxis: [
            { type: 'category', data: dates, gridIndex: 0, axisLabel: { show: false } },
            { type: 'category', data: dates, gridIndex: 1 }
        ],
        yAxis: [
            { scale: true, gridIndex: 0, name: 'Price' },
            { scale: true, gridIndex: 1, name: 'Vol', splitNumber: 2 }
        ],
        series: [
            {
                name: 'Price',
                type: 'line',
                data: prices,
                xAxisIndex: 0,
                yAxisIndex: 0,
                smooth: true
            },
            ...maSeries, // Add all MA series as line charts
            {
                name: '买入',
                type: 'scatter',
                data: buySignals,
                xAxisIndex: 0,
                yAxisIndex: 0,
                symbol: 'triangle',
                symbolRotate: 180,
                symbolSize: 14,
                itemStyle: { color: '#52c41a' }
            },
            {
                name: '卖出',
                type: 'scatter',
                data: sellSignals,
                xAxisIndex: 0,
                yAxisIndex: 0,
                symbol: 'triangle',
                symbolRotate: 0,
                symbolSize: 14,
                itemStyle: { color: '#ff4d4f' }
            },
            {
                name: 'Volume',
                type: 'bar',
                data: volumes,
                xAxisIndex: 1,
                yAxisIndex: 1,
                itemStyle: { color: '#1890ff' }
            }
        ],
        dataZoom: [{ type: 'inside', xAxisIndex: [0, 1] }, { type: 'slider', xAxisIndex: [0, 1] }]
    };
    myChart.setOption(option, true);
}

    // Helper function to calculate Moving Average
    function calculateMA(data, period) {
        const result = [];
        for (let i = 0; i < data.length; i++) {
            if (i < period - 1) {
                result.push('-');
            } else {
                const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                result.push(sum / period);
            }
        }
        return result;
    }

    // Helper function to assign colors to MA lines
    function getColorForPeriod(period) {
        const colors = {
            12: '#faad14', // Orange
            24: '#1890ff', // Blue
            48: '#52c41a'  // Green
        };
        return colors[period] || '#000000'; // Default to black
    }

    // --- Grid.js 表格 ---
    function updateGridTable() {
        const allKeys = perfData.length > 0 ? Object.keys(perfData[0]).filter(key => 
            !['symbol', 'symbol_name', 'industry', 'strategy'].includes(key) // Exclude these keys
        ) : [];

        const columns = [
            {
                name: '代码',
                formatter: (cell) => cell,
                filter: 'input',
                placeholder: 'Filter by Symbol'
            },
            {
                name: '名称',
                formatter: (cell) => cell,
                filter: 'input',
                placeholder: 'Filter by Symbol Name'
            },
            {
                name: '行业',
                formatter: (cell) => cell,
                filter: 'input',
                placeholder: 'Filter by Industry',
            },
            {
                name: '策略',
                formatter: (cell) => cell,
                filter: 'input',
                placeholder: 'Filter by Strategy'
            },
            ...allKeys.map(key => ({
                name: key,
                formatter: (cell) => cell,
                filter: 'input',
                placeholder: `Filter by ${key}`,
                
            }))
        ];

        const data = perfData.map(d => [
            d.symbol,           // Explicitly map Symbol
            d.symbol_name || '',// Explicitly map Symbol Name
            d.industry || '',   // Explicitly map Industry
            d.strategy || '',
            ...allKeys.map(key => d[key]) // Map remaining keys
        ]);

        new gridjs.Grid({
            columns: columns,
            data: data,
            sort: true,
            pagination: {
                limit: 20, // Default number of rows per page
                limits: [10, 20, 50], // Options for row count per page
                summary: true // Optional: Show a summary of current page info
            },
            search: true,
            style: {
                table: {
                    'min-width': '100%',
                    'overflow-x': 'auto'
                },
                th: {
                    'min-width': '150px'
                },
                td: {
                    'min-width': '150px'
                }
            }
        }).render(document.getElementById('performance-table'));
    }
    // 渲染页面结构
    const App = () => React.createElement('div', null, [
        React.createElement(ControlPanel),
        React.createElement('div', { className: "card" }, [
            React.createElement('div', { className: "section-title" }, "价格走势与成交量"),
            React.createElement('div', { id: "chart-container" })
        ]),
        React.createElement('div', { className: "card" }, [
            React.createElement('div', { className: "section-title" }, "策略表现排名"),
            React.createElement('div', { id: "performance-table" })
        ])
    ]);

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
</script>
</body>
</html>